<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sayra FULL ‚Äî 1v1 Match (Text + Voice + Questions)</title>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    :root{
      --bg0:#050816; --bg1:#0b1030;
      --card:rgba(255,255,255,.07);
      --stroke:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --a:#7c3aed; --b:#06b6d4;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --shadow:0 18px 50px rgba(0,0,0,.45);
      --r:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--txt);
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(124,58,237,.32), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(6,182,212,.20), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .app{
      width:min(1220px, 100%);
      margin:0 auto;
      padding:18px;
      display:grid;
      grid-template-columns: 370px 1fr;
      gap:14px;
      min-height:100%;
    }
    @media (max-width:980px){
      .app{grid-template-columns:1fr}
    }
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel{padding:14px 16px}
    .brand{
      display:flex; gap:10px; align-items:center;
      padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,.06)
    }
    .logo{
      width:46px;height:46px;border-radius:16px;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(6,182,212,.85));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 10px 28px rgba(124,58,237,.18);
      flex:0 0 auto;
    }
    .title{font-weight:950; letter-spacing:-.3px; font-size:16px}
    .subtitle{font-size:12px; color:var(--muted); margin-top:2px}
    .stats{display:flex; gap:8px; flex-wrap:wrap; margin:12px 0 8px}
    .pill{
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-size:12px; color: rgba(255,255,255,.78);
      display:inline-flex; gap:8px; align-items:center;
      user-select:none;
    }
    .lbl{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    .in, .sel{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--txt);
      outline:none;
      appearance:none;
    }
    .row{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .btn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      padding:12px 14px;
      border-radius:999px;
      font-weight:900;
      display:inline-flex; align-items:center; gap:10px;
      transition:.15s ease;
      user-select:none;
      text-decoration:none;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.20);}
    .btn.primary{background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(6,182,212,.85)); border-color: rgba(124,58,237,.4);}
    .btn.danger{background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(245,158,11,.85)); border-color: rgba(239,68,68,.35);}
    .btn.ghost{background: rgba(255,255,255,.04);}
    .btn:disabled{opacity:.5; cursor:not-allowed; transform:none}
    .status{
      margin-top:12px; padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      color:rgba(255,255,255,.75);
      font-size:13px;
      line-height:1.45;
      white-space:pre-line;
    }
    .hint{margin-top:10px; font-size:12px; color:var(--muted)}
    .sep{height:1px; background:rgba(255,255,255,.06); margin:14px 0}

    /* Chat */
    .chat{display:flex; flex-direction:column}
    .chatHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .chatTitle{font-weight:950}
    .who{margin-top:6px; color:var(--muted); font-size:12.5px; white-space:pre-line}
    .typing{margin-top:6px; font-size:12px; color:rgba(255,255,255,.70); min-height:16px}
    .chatBody{
      flex:1;
      min-height: 420px;
      padding:12px 16px;
      overflow:auto;
      background: rgba(0,0,0,.10);
    }
    .bubble{
      max-width: 78%;
      padding:10px 12px;
      border-radius:16px;
      margin:8px 0;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      white-space:pre-wrap;
      word-break:break-word;
    }
    .bubble.me{margin-left:auto; border-color: rgba(124,58,237,.25); background: rgba(124,58,237,.12);}
    .bubble.sys{border-style:dashed; opacity:.92}
    .meta{font-size:11px; color:rgba(255,255,255,.55); margin-top:4px}
    .chatBar{
      padding:14px 16px;
      border-top:1px solid rgba(255,255,255,.06);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .msgIn{
      flex:1;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--txt);
      outline:none;
    }

    /* MINI ICEBREAKER BAR (small space) */
    .iceBar{
      margin-top:10px;
      display:none;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
    }
    .iceLeft{
      display:flex; gap:8px; align-items:center;
      min-width: 120px;
    }
    .iceTitle{
      font-weight:900;
      font-size:12px;
      color: rgba(255,255,255,.82);
    }
    .iceCount{
      font-size:12px;
      color: rgba(255,255,255,.60);
    }
    .iceQ{
      flex:1;
      font-size:13px;
      color: rgba(255,255,255,.90);
      line-height:1.25;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .iceBtns{display:flex; gap:8px}
    .iceBtn{
      width:42px; height:36px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      font-weight:900;
      cursor:pointer;
    }
    .iceBtn:disabled{opacity:.4; cursor:not-allowed}

    /* Toast */
    .toastWrap{
      position:fixed; right:16px; bottom:16px;
      display:flex; flex-direction:column; gap:10px;
      z-index:1000; pointer-events:none;
    }
    .toast{
      pointer-events:none;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.88);
      box-shadow: var(--shadow);
      font-size:13px;
      max-width: 360px;
    }
    .toast.ok{border-color: rgba(34,197,94,.35)}
    .toast.bad{border-color: rgba(239,68,68,.35)}
    .toast.warn{border-color: rgba(245,158,11,.35)}
  </style>
</head>

<body>
  <div class="app">
    <aside class="card panel">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">Sayra FULL</div>
          <div class="subtitle">1v1 Match ‚Ä¢ Text ‚Ä¢ Voice ‚Ä¢ Questions</div>
        </div>
      </div>

      <div class="stats">
        <div class="pill">üë• Online: <b id="online">0</b></div>
        <div class="pill">‚è≥ Waiting: <b id="waitingCount">0</b></div>
        <div class="pill">üè† Rooms: <b id="roomsCount">0</b></div>
      </div>

      <label class="lbl">Ism</label>
      <input id="name" class="in" placeholder="Masalan: Sharof" maxlength="24"/>

      <label class="lbl">Gender</label>
      <select id="gender" class="sel">
        <option value="male">Male</option>
        <option value="female">Female</option>
      </select>

      <label class="lbl">Daraja</label>
      <select id="level" class="sel">
        <option>A1</option><option>A2</option><option selected>B1</option>
        <option>B2</option><option>C1</option><option>C2</option>
      </select>

      <div class="row">
        <button id="findBtn" class="btn primary">üîé Find partner</button>
        <button id="leaveBtn" class="btn danger" disabled>üö™ Leave</button>
      </div>

      <div class="row">
        <button id="voiceOnBtn" class="btn ghost" disabled>üéô Voice ON</button>
        <button id="voiceOffBtn" class="btn ghost" disabled>üîá Voice OFF</button>
      </div>

      <div class="row">
        <button id="reportBtn" class="btn ghost" disabled>üö´ Report</button>
      </div>

      <div id="status" class="status">Ulanish kutilyapti‚Ä¶</div>
      <div class="hint">
        Matchdan keyin 3 ta ‚Äúicebreaker‚Äù savol chiqadi. ‚Üê ‚Üí bilan o‚Äòtkazasiz.
      </div>
    </aside>

    <main class="card chat">
      <header class="chatHead">
        <div style="width:100%">
          <div class="chatTitle">Chat</div>
          <div id="who" class="who">Partner topilmagan.</div>
          <div id="typingLine" class="typing"></div>

          <!-- ICEBREAKER BAR (small) -->
          <div id="iceBar" class="iceBar">
            <div class="iceLeft">
              <div class="iceTitle">Questions</div>
              <div id="iceCount" class="iceCount">1/3</div>
            </div>

            <div id="iceQ" class="iceQ">‚Äî</div>

            <div class="iceBtns">
              <button id="icePrev" class="iceBtn">‚Üê</button>
              <button id="iceNext" class="iceBtn">‚Üí</button>
            </div>
          </div>
        </div>
      </header>

      <section id="chatBody" class="chatBody"></section>

      <footer class="chatBar">
        <input id="msg" class="msgIn" placeholder="Xabar yozing‚Ä¶" maxlength="900" disabled/>
        <button id="sendBtn" class="btn primary" disabled>Send</button>
      </footer>
    </main>
  </div>

  <audio id="remoteAudio" autoplay></audio>
  <div class="toastWrap" id="toastWrap"></div>

  <script>
    // ---------- helpers ----------
    const $ = (id) => document.getElementById(id);
    const fmtTime = (t) => new Date(t || Date.now()).toLocaleTimeString();

    function toast(msg, kind="ok"){
      const wrap = $("toastWrap");
      const t = document.createElement("div");
      t.className = "toast " + (kind || "");
      t.textContent = msg;
      wrap.appendChild(t);
      setTimeout(() => t.remove(), 2600);
    }

    // clientId
    const LS_KEY = "sayra_client_id";
    let clientId = localStorage.getItem(LS_KEY);
    if(!clientId){
      clientId = "c_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
      localStorage.setItem(LS_KEY, clientId);
    }

    // socket
    const socket = io();

    // UI
    const onlineEl = $("online");
    const waitingCountEl = $("waitingCount");
    const roomsCountEl = $("roomsCount");

    const nameIn = $("name");
    const genderSel = $("gender");
    const levelSel = $("level");

    const findBtn = $("findBtn");
    const leaveBtn = $("leaveBtn");
    const voiceOnBtn = $("voiceOnBtn");
    const voiceOffBtn = $("voiceOffBtn");
    const reportBtn = $("reportBtn");

    const statusBox = $("status");
    const whoEl = $("who");
    const typingLine = $("typingLine");
    const chatBody = $("chatBody");
    const msgIn = $("msg");
    const sendBtn = $("sendBtn");

    // Icebreaker UI
    const iceBar = $("iceBar");
    const iceCount = $("iceCount");
    const iceQ = $("iceQ");
    const icePrev = $("icePrev");
    const iceNext = $("iceNext");

    // state
    let my = { name:"", gender:"male", level:"B1" };
    let partner = null;
    let roomId = null;

    // read receipts
    let lastPartnerReadId = null;

    // typing
    let typingTimer = null;
    let typingLocal = false;

    // icebreaker state
    let ice = { questions: [], index: 0, total: 0 };

    // voice
    let pc = null;
    let localStream = null;
    const remoteAudio = $("remoteAudio");
    const RTC_CFG = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    function setStatus(text, type="info"){
      statusBox.textContent = text;
      statusBox.style.color =
        type === "error" ? "rgba(239,68,68,.95)" :
        type === "ok" ? "rgba(34,197,94,.95)" :
        type === "wait" ? "rgba(245,158,11,.95)" :
        "rgba(255,255,255,.75)";
    }

    function setChatEnabled(on){
      msgIn.disabled = !on;
      sendBtn.disabled = !on;
      leaveBtn.disabled = !on;
      reportBtn.disabled = !on;
      voiceOnBtn.disabled = !on;
      voiceOffBtn.disabled = !on;
      findBtn.disabled = on;

      if(!on){
        iceBar.style.display = "none";
        ice = { questions: [], index: 0, total: 0 };
      }
    }

    function updateWho(){
      if(!partner){
        whoEl.textContent = "Partner topilmagan.";
        return;
      }
      whoEl.textContent =
        `Siz: ${my.name} (${my.level}, ${my.gender})\n` +
        `Partner: ${partner.name} (${partner.level}, ${partner.gender})`;
    }

    function clearChat(){
      chatBody.innerHTML = "";
      typingLine.textContent = "";
      lastPartnerReadId = null;
    }

    function addBubble({from, text, at, id}, kind="user"){
      const wrap = document.createElement("div");
      wrap.className = "bubble" + (from === my.name ? " me" : "") + (kind === "sys" ? " sys" : "");
      wrap.textContent = text;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `${from} ‚Ä¢ ${fmtTime(at)}` + (from === my.name && id && lastPartnerReadId === id ? " ‚Ä¢ ‚úÖ read" : "");
      wrap.appendChild(meta);

      wrap.dataset.msgId = id || "";
      chatBody.appendChild(wrap);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function markReadLabel(){
      if(!lastPartnerReadId) return;
      const bubbles = Array.from(chatBody.querySelectorAll(".bubble.me"));
      for(const b of bubbles){
        const id = b.dataset.msgId;
        if(id && id === lastPartnerReadId){
          const meta = b.querySelector(".meta");
          if(meta && !meta.textContent.includes("‚úÖ read")){
            meta.textContent = meta.textContent + " ‚Ä¢ ‚úÖ read";
          }
        }
      }
    }

    function idleState(msg){
      stopVoice();
      roomId = null;
      partner = null;
      updateWho();
      setChatEnabled(false);
      findBtn.disabled = false;
      setStatus(msg || "Tayyor.", "info");
    }

    // ICE UI render
    function renderIce(){
      if(!ice.questions.length){
        iceBar.style.display = "none";
        return;
      }
      iceBar.style.display = "flex";

      iceCount.textContent = `${ice.index + 1}/${ice.total}`;
      iceQ.textContent = ice.questions[ice.index] || "‚Äî";

      icePrev.disabled = ice.index <= 0;
      iceNext.disabled = ice.index >= ice.total - 1;
    }

    icePrev.addEventListener("click", () => {
      if(!roomId) return;
      socket.emit("ice_prev");
    });
    iceNext.addEventListener("click", () => {
      if(!roomId) return;
      socket.emit("ice_next");
    });

    // socket lifecycle
    socket.on("connect", () => {
      socket.emit("hello", { clientId });
    });

    socket.on("hello_ok", (d) => { if(d?.clientId) clientId = d.clientId; });

    socket.on("global_stats", (s) => {
      onlineEl.textContent = s.onlineUsers ?? 0;
      roomsCountEl.textContent = s.rooms ?? 0;
      const q = s.queue || {};
      let total = 0;
      for(const k in q) total += Number(q[k] || 0);
      waitingCountEl.textContent = total;
    });

    socket.on("status", (s) => {
      if(s.type === "waiting") setStatus(s.message, "wait");
      else if(s.type === "error") setStatus(s.message, "error");
      else if(s.type === "matched") setStatus(s.message, "ok");
      else setStatus(s.message, "info");
    });

    socket.on("matched", (data) => {
      roomId = data.roomId;
      my = data.you;
      partner = data.partner;

      updateWho();
      setChatEnabled(true);
      clearChat();

      addBubble({ from:"SYSTEM", text:"‚úÖ Match topildi. Savollardan gaplashib boshlang!", at:Date.now() }, "sys");
      toast("Match topildi ‚úÖ", "ok");

      socket.emit("get_history");
    });

    socket.on("history", (h) => {
      (h?.items || []).forEach(m => addBubble({ from:m.from, text:m.text, at:m.at, id:m.id }, "user"));
    });

    // NEW: icebreaker from server
    socket.on("icebreaker", (p) => {
      ice.questions = p.questions || [];
      ice.index = Number(p.index || 0);
      ice.total = Number(p.total || ice.questions.length || 0);
      renderIce();
    });

    socket.on("message", (m) => {
      addBubble({ from:m.from, text:m.text, at:m.at, id:m.id }, "user");

      // auto read receipt for partner messages
      if(partner && m.from === partner.name && m.id){
        socket.emit("read_up_to", { msgId: m.id });
      }
    });

    socket.on("read_up_to", (r) => {
      lastPartnerReadId = r.msgId;
      markReadLabel();
    });

    socket.on("typing", (t) => {
      if(!partner) return;
      if(t.on){
        typingLine.textContent = `${t.from} typing‚Ä¶`;
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => (typingLine.textContent = ""), 1100);
      } else typingLine.textContent = "";
    });

    socket.on("partner_left", () => {
      addBubble({ from:"SYSTEM", text:"Partner chiqib ketdi. Yangi partner qidiring.", at:Date.now() }, "sys");
      toast("Partner chiqib ketdi", "warn");
      idleState("Partner chiqib ketdi. Yana Find partner bosing.");
    });

    socket.on("room_closed", () => {
      addBubble({ from:"SYSTEM", text:"Room yopildi.", at:Date.now() }, "sys");
      idleState("Room yopildi. Yana Find partner bosing.");
    });

    // actions
    findBtn.addEventListener("click", () => {
      const name = nameIn.value.trim();
      const gender = genderSel.value;
      const level = levelSel.value;

      if(!name) return setStatus("Ism kiriting.", "error");

      my = { name, gender, level };
      partner = null;
      roomId = null;

      updateWho();
      setChatEnabled(false);
      clearChat();
      setStatus("Qidirilyapti‚Ä¶", "wait");

      socket.emit("find_partner", { clientId, name, gender, level });
    });

    leaveBtn.addEventListener("click", () => {
      socket.emit("leave_chat");
      toast("Chiqildi", "warn");
      idleState("Chiqildi. Yana Find partner bosing.");
    });

    reportBtn.addEventListener("click", () => {
      socket.emit("report_partner");
      toast("Report yuborildi", "warn");
      setStatus("Report yuborildi.", "info");
    });

    function send(){
      const text = msgIn.value.trim();
      if(!text) return;
      socket.emit("send_message", { text });
      msgIn.value = "";
      if(typingLocal){
        typingLocal = false;
        socket.emit("typing", { on:false });
      }
    }

    sendBtn.addEventListener("click", send);

    msgIn.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        send();
        return;
      }
      if(!typingLocal){
        typingLocal = true;
        socket.emit("typing", { on:true });
      }
    });

    msgIn.addEventListener("blur", () => {
      if(typingLocal){
        typingLocal = false;
        socket.emit("typing", { on:false });
      }
    });

    // voice
    async function ensureLocalAudio(){
      if(localStream) return localStream;
      localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      return localStream;
    }

    async function startVoice(){
      if(!roomId || !partner) return setStatus("Avval match bo‚Äòling.", "error");
      if(pc) return setStatus("Voice allaqachon yoqilgan.", "info");
      try{
        const stream = await ensureLocalAudio();
        pc = new RTCPeerConnection(RTC_CFG);
        stream.getTracks().forEach(t => pc.addTrack(t, stream));
        pc.ontrack = (e) => { remoteAudio.srcObject = e.streams[0]; remoteAudio.play().catch(()=>{}); };
        pc.onicecandidate = (e) => { if(e.candidate) socket.emit("voice_ice", e.candidate); };
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit("voice_offer", offer);
        toast("Voice ON üéô", "ok");
        setStatus("üéô Voice yoqildi (offer yuborildi)", "ok");
      } catch {
        setStatus("Mikrofon ruxsati berilmadi yoki xato.", "error");
        toast("Mic permission kerak", "bad");
        stopVoice();
      }
    }

    async function handleOffer(payload){
      try{
        const offer = payload.offer;
        if(!pc){
          const stream = await ensureLocalAudio();
          pc = new RTCPeerConnection(RTC_CFG);
          stream.getTracks().forEach(t => pc.addTrack(t, stream));
          pc.ontrack = (e) => { remoteAudio.srcObject = e.streams[0]; remoteAudio.play().catch(()=>{}); };
          pc.onicecandidate = (e) => { if(e.candidate) socket.emit("voice_ice", e.candidate); };
        }
        await pc.setRemoteDescription(offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.emit("voice_answer", answer);
        setStatus("üéß Voice ulanish (answer yuborildi)", "ok");
      } catch {
        setStatus("Voice offer qabul qilishda xato.", "error");
        stopVoice();
      }
    }

    async function handleAnswer(payload){
      try{
        if(!pc) return;
        await pc.setRemoteDescription(payload.answer);
        setStatus("‚úÖ Voice connection ready", "ok");
      } catch {
        setStatus("Voice answer qo‚Äòyishda xato.", "error");
      }
    }

    async function handleIce(payload){
      try{
        if(pc && payload.candidate) await pc.addIceCandidate(payload.candidate);
      } catch {}
    }

    function stopVoice(){
      try{ pc?.close(); } catch {}
      pc = null;
      try{ localStream?.getTracks().forEach(t => t.stop()); } catch {}
      localStream = null;
    }

    voiceOnBtn.addEventListener("click", startVoice);
    voiceOffBtn.addEventListener("click", () => { stopVoice(); toast("Voice OFF", "warn"); setStatus("üîá Voice o‚Äòchirildi.", "info"); });

    socket.on("voice_offer", handleOffer);
    socket.on("voice_answer", handleAnswer);
    socket.on("voice_ice", handleIce);

    // init
    setChatEnabled(false);
    updateWho();
  </script>
</body>
</html>
